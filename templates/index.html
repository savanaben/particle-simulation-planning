<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particle Collision Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0 30px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 2px;
            color: #fff;
            text-transform: uppercase;
        }

        h1 span {
            color: #e94560;
            font-weight: 600;
        }

        .subtitle {
            color: #888;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            align-items: start;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .control-panel h2 {
            font-size: 1rem;
            font-weight: 500;
            color: #e94560;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
        }

        .control-group label span.value {
            color: #fff;
            font-weight: 500;
            font-family: 'Consolas', monospace;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(233, 69, 96, 0.4);
        }

        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 0.9rem;
            font-family: 'Consolas', monospace;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #e94560;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560, #c23a51);
            color: #fff;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        /* Canvas Area */
        .canvas-area {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .canvas-header h2 {
            font-size: 1rem;
            font-weight: 500;
            color: #4ecdc4;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .time-display {
            font-family: 'Consolas', monospace;
            font-size: 1.1rem;
            color: #fff;
        }

        .canvas-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0a0a14;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        #simulationCanvas {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            background: #111;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            align-items: center;
        }

        .playback-controls button {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .playback-controls button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .playback-controls button.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #000;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .speed-control label {
            font-size: 0.8rem;
            color: #888;
        }

        .speed-control input[type="range"] {
            width: 100px;
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 16px;
            cursor: pointer;
        }

        .progress-bar-fill {
            height: 100%;
            background: #4ecdc4;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
        }

        .stat-box .label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .stat-box.no2 .value { color: #e94560; }
        .stat-box.n2o4 .value { color: #4ecdc4; }
        .stat-box.collisions .value { color: #ffd93d; }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #aaa;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.no2 { background: #e94560; }
        .legend-dot.n2o4 { background: #4ecdc4; }

        /* Error message */
        .error-message {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid #e94560;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            color: #ff8a9b;
            font-size: 0.85rem;
        }

        /* Loading state */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading span {
            animation: pulse 1.5s infinite;
        }

        /* Data Tables Section */
        .data-section {
            margin-top: 40px;
            display: none;
        }

        .data-section.visible {
            display: block;
        }

        .data-section h2 {
            font-size: 1.2rem;
            font-weight: 400;
            color: #fff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-section h2 span {
            color: #ffd93d;
        }

        /* Collision Events Table */
        .collision-table-wrapper {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .collision-table-wrapper h3 {
            font-size: 0.95rem;
            font-weight: 500;
            color: #ffd93d;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: #aaa;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #ddd;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .data-table .particle-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .data-table .particle-badge.no2 {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .data-table .particle-badge.n2o4 {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .data-table .arrow {
            color: #ffd93d;
            font-weight: bold;
            padding: 0 8px;
        }

        /* Particle Trajectories */
        .trajectories-wrapper {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trajectories-wrapper h3 {
            font-size: 0.95rem;
            font-weight: 500;
            color: #4ecdc4;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .particle-group {
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }

        .particle-group:last-child {
            margin-bottom: 0;
        }

        .particle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: background 0.2s;
        }

        .particle-header:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .particle-header .particle-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .particle-header .particle-id {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .particle-header .particle-id.no2 { color: #e94560; }
        .particle-header .particle-id.n2o4 { color: #4ecdc4; }

        .particle-header .particle-meta {
            font-size: 0.8rem;
            color: #888;
        }

        .particle-header .toggle-icon {
            color: #666;
            transition: transform 0.2s;
        }

        .particle-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .particle-keyframes {
            display: none;
            padding: 0;
        }

        .particle-keyframes.expanded {
            display: block;
        }

        .particle-keyframes table {
            width: 100%;
        }

        .particle-keyframes th {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 16px;
            font-size: 0.7rem;
        }

        .particle-keyframes td {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        .keyframe-highlight {
            background: rgba(255, 215, 61, 0.1) !important;
        }

        .collision-note {
            font-size: 0.75rem;
            color: #ffd93d;
            font-style: italic;
        }

        /* Copy button */
        .copy-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #aaa;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            margin-bottom: 16px;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .copy-btn.copied {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }

        /* Click-to-copy cells */
        .copyable {
            cursor: pointer;
            position: relative;
            transition: background 0.15s;
        }

        .copyable:hover {
            background: rgba(78, 205, 196, 0.15) !important;
        }

        .copyable.copied {
            background: rgba(78, 205, 196, 0.3) !important;
        }

        .copyable.copied::after {
            content: '✓';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            color: #4ecdc4;
            font-size: 0.7rem;
        }

        /* Time format helper text */
        .time-format-note {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Particle <span>Collision</span> Simulator</h1>
            <p class="subtitle">NO<sub>2</sub> + NO<sub>2</sub> → N<sub>2</sub>O<sub>4</sub> Pre-calculated Animation</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <h2>Parameters</h2>

                <div class="control-group">
                    <label>
                        Container Size
                        <span class="value"><span id="containerSizeValue">300</span> × <span id="containerSizeValue2">300</span> px</span>
                    </label>
                    <input type="range" id="containerSize" min="200" max="500" value="300" step="10">
                </div>

                <div class="control-group">
                    <label>
                        NO<sub>2</sub> Particles
                        <span class="value" id="numParticlesValue">15</span>
                    </label>
                    <input type="range" id="numParticles" min="4" max="15" value="15">
                </div>

                <div class="control-group">
                    <label>
                        Collisions
                        <span class="value" id="numCollisionsValue">6</span>
                    </label>
                    <input type="range" id="numCollisions" min="1" max="7" value="6">
                </div>

                <div class="control-group">
                    <label>
                        Particle Speed
                        <span class="value"><span id="particleSpeedValue">80</span> px/s</span>
                    </label>
                    <input type="range" id="particleSpeed" min="30" max="200" value="80" step="10">
                </div>

                <div class="control-group">
                    <label>
                        Animation Duration
                        <span class="value"><span id="animationDurationValue">8</span> s</span>
                    </label>
                    <input type="range" id="animationDuration" min="4" max="20" value="8" step="1">
                </div>

                <div class="control-group">
                    <label>Random Seed (optional)</label>
                    <input type="number" id="randomSeed" placeholder="Leave empty for random">
                </div>

                <div class="divider"></div>

                <button class="btn btn-primary" id="runBtn">Run Simulation</button>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>

            <div class="canvas-area">
                <div class="canvas-header">
                    <h2>Simulation Preview</h2>
                    <div class="time-display">
                        <span id="currentTime">0.00</span>s / <span id="totalTime">8.00</span>s
                    </div>
                </div>

                <div class="canvas-wrapper">
                    <canvas id="simulationCanvas" width="300" height="300"></canvas>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>

                <div class="playback-controls">
                    <button id="playPauseBtn">▶ Play</button>
                    <button id="restartBtn">↺ Restart</button>
                    <button id="stepBtn">⏭ Step</button>

                    <div class="speed-control">
                        <label>Speed: <span id="playbackSpeedValue">1</span>x</label>
                        <input type="range" id="playbackSpeed" min="0.25" max="3" value="1" step="0.25">
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot no2"></div>
                        <span>NO<sub>2</sub></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot n2o4"></div>
                        <span>N<sub>2</sub>O<sub>4</sub></span>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-box no2">
                        <div class="value" id="activeNo2">0</div>
                        <div class="label">Active NO<sub>2</sub></div>
                    </div>
                    <div class="stat-box n2o4">
                        <div class="value" id="activeN2o4">0</div>
                        <div class="label">Active N<sub>2</sub>O<sub>4</sub></div>
                    </div>
                    <div class="stat-box collisions">
                        <div class="value" id="collisionCount">0</div>
                        <div class="label">Collisions</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Section -->
        <div class="data-section" id="dataSection">
            <h2>Animation <span>Keyframe Data</span></h2>

            <!-- Collision Events -->
            <div class="collision-table-wrapper">
                <h3>Collision Events</h3>
                <p class="time-format-note">Time format: seconds:frames (60fps). Click time cells to copy.</p>
                <table class="data-table" id="collisionTable">
                    <thead>
                        <tr>
                            <th>Time (s:f)</th>
                            <th>Position (x, y)</th>
                            <th>Particles Destroyed</th>
                            <th></th>
                            <th>Particle Created</th>
                        </tr>
                    </thead>
                    <tbody id="collisionTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Particle Trajectories -->
            <div class="trajectories-wrapper">
                <h3>Particle Trajectories</h3>
                <button class="copy-btn" id="copyAllBtn">Copy All Data as CSV</button>
                <div id="particleTrajectories">
                    <!-- Particle groups will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');

        // Controls
        const containerSizeInput = document.getElementById('containerSize');
        const numParticlesInput = document.getElementById('numParticles');
        const numCollisionsInput = document.getElementById('numCollisions');
        const particleSpeedInput = document.getElementById('particleSpeed');
        const animationDurationInput = document.getElementById('animationDuration');
        const randomSeedInput = document.getElementById('randomSeed');
        const runBtn = document.getElementById('runBtn');

        // Playback
        const playPauseBtn = document.getElementById('playPauseBtn');
        const restartBtn = document.getElementById('restartBtn');
        const stepBtn = document.getElementById('stepBtn');
        const playbackSpeedInput = document.getElementById('playbackSpeed');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // Displays
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const errorMessage = document.getElementById('errorMessage');

        // Simulation state
        let simulationData = null;
        let currentTime = 0;
        let isPlaying = false;
        let playbackSpeed = 1;
        let lastFrameTime = null;
        let animationId = null;

        // Colors
        const NO2_COLOR = '#e94560';
        const N2O4_COLOR = '#4ecdc4';
        const PARTICLE_RADIUS = 6;

        // SVG images for particles
        const no2Image = new Image();
        const n2o4Image = new Image();
        let imagesLoaded = 0;
        const IMAGE_HEIGHT = 24; // Target height for all particles
        
        // SVG aspect ratios (from viewBox dimensions)
        const NO2_ASPECT = 21.06 / 22.39; // width/height
        const N2O4_ASPECT = 41.12 / 22.39; // width/height
        
        // Calculate widths based on aspect ratios
        const NO2_WIDTH = IMAGE_HEIGHT * NO2_ASPECT;
        const N2O4_WIDTH = IMAGE_HEIGHT * N2O4_ASPECT;
        
        // Store random starting rotations per particle
        const particleRotations = new Map();

        // Offscreen canvas for applying brightness effects
        const offscreenCanvas = document.createElement('canvas');
        const offscreenCtx = offscreenCanvas.getContext('2d');

        // Load SVG images
        no2Image.onload = () => {
            imagesLoaded++;
            if (imagesLoaded === 2) draw();
        };
        n2o4Image.onload = () => {
            imagesLoaded++;
            if (imagesLoaded === 2) draw();
        };
        no2Image.src = '/static/no2.svg';
        n2o4Image.src = '/static/n2o4.svg';

        // Update display values
        function updateDisplayValues() {
            document.getElementById('containerSizeValue').textContent = containerSizeInput.value;
            document.getElementById('containerSizeValue2').textContent = containerSizeInput.value;
            document.getElementById('numParticlesValue').textContent = numParticlesInput.value;
            document.getElementById('numCollisionsValue').textContent = numCollisionsInput.value;
            document.getElementById('particleSpeedValue').textContent = particleSpeedInput.value;
            document.getElementById('animationDurationValue').textContent = animationDurationInput.value;
            document.getElementById('playbackSpeedValue').textContent = playbackSpeedInput.value;

            // Update max collisions based on particles
            const maxCollisions = Math.floor(numParticlesInput.value / 2);
            numCollisionsInput.max = maxCollisions;
            if (parseInt(numCollisionsInput.value) > maxCollisions) {
                numCollisionsInput.value = maxCollisions;
                document.getElementById('numCollisionsValue').textContent = maxCollisions;
            }

            // Update canvas size
            const size = parseInt(containerSizeInput.value);
            canvas.width = size;
            canvas.height = size;

            // Redraw if we have data
            if (simulationData) {
                draw();
            }
        }

        // Attach listeners
        [containerSizeInput, numParticlesInput, numCollisionsInput, particleSpeedInput, animationDurationInput].forEach(input => {
            input.addEventListener('input', updateDisplayValues);
        });

        playbackSpeedInput.addEventListener('input', () => {
            playbackSpeed = parseFloat(playbackSpeedInput.value);
            document.getElementById('playbackSpeedValue').textContent = playbackSpeed;
        });

        // Progress bar click to seek
        progressBar.addEventListener('click', (e) => {
            if (!simulationData) return;
            const rect = progressBar.getBoundingClientRect();
            const ratio = (e.clientX - rect.left) / rect.width;
            currentTime = ratio * simulationData.params.animation_duration;
            draw();
            updateTimeDisplay();
        });

        // Run simulation
        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            errorMessage.style.display = 'none';

            const params = {
                container_width: parseInt(containerSizeInput.value),
                container_height: parseInt(containerSizeInput.value),
                num_particles: parseInt(numParticlesInput.value),
                num_collisions: parseInt(numCollisionsInput.value),
                particle_speed: parseInt(particleSpeedInput.value),
                animation_duration: parseInt(animationDurationInput.value),
                random_seed: randomSeedInput.value ? parseInt(randomSeedInput.value) : null
            };

            try {
                const response = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Simulation failed');
                }

                simulationData = data;
                currentTime = 0;
                totalTimeDisplay.textContent = data.params.animation_duration.toFixed(2);
                
                // Clear previous rotations and let new ones be generated on first draw
                particleRotations.clear();
                
                // Reset playback
                isPlaying = false;
                playPauseBtn.textContent = '▶ Play';
                playPauseBtn.classList.remove('active');

                draw();
                updateTimeDisplay();
                populateDataTables();

            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.style.display = 'block';
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run Simulation';
            }
        });

        // Playback controls
        playPauseBtn.addEventListener('click', () => {
            if (!simulationData) return;
            isPlaying = !isPlaying;
            playPauseBtn.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
            playPauseBtn.classList.toggle('active', isPlaying);
            
            if (isPlaying) {
                lastFrameTime = performance.now();
                animate();
            }
        });

        restartBtn.addEventListener('click', () => {
            currentTime = 0;
            draw();
            updateTimeDisplay();
        });

        stepBtn.addEventListener('click', () => {
            if (!simulationData) return;
            currentTime = Math.min(currentTime + 0.1, simulationData.params.animation_duration);
            draw();
            updateTimeDisplay();
        });

        // Animation loop
        function animate() {
            if (!isPlaying || !simulationData) return;

            const now = performance.now();
            const delta = (now - lastFrameTime) / 1000; // Convert to seconds
            lastFrameTime = now;

            currentTime += delta * playbackSpeed;

            if (currentTime >= simulationData.params.animation_duration) {
                currentTime = simulationData.params.animation_duration;
                isPlaying = false;
                playPauseBtn.textContent = '▶ Play';
                playPauseBtn.classList.remove('active');
            }

            draw();
            updateTimeDisplay();

            if (isPlaying) {
                animationId = requestAnimationFrame(animate);
            }
        }

        // Update time display
        function updateTimeDisplay() {
            if (!simulationData) return;
            currentTimeDisplay.textContent = currentTime.toFixed(2);
            const progress = (currentTime / simulationData.params.animation_duration) * 100;
            progressFill.style.width = `${progress}%`;
        }

        // Get interpolated position for a particle at given time
        function getParticlePosition(particle, time) {
            if (time < particle.start_time || time > particle.end_time) {
                return null;
            }

            const keyframes = particle.keyframes;
            
            // Find surrounding keyframes
            for (let i = 0; i < keyframes.length - 1; i++) {
                const kf1 = keyframes[i];
                const kf2 = keyframes[i + 1];

                if (time >= kf1.time && time <= kf2.time) {
                    // Linear interpolation
                    const t = (time - kf1.time) / (kf2.time - kf1.time);
                    return {
                        x: kf1.x + t * (kf2.x - kf1.x),
                        y: kf1.y + t * (kf2.y - kf1.y)
                    };
                }
            }

            // At the last keyframe
            if (keyframes.length > 0) {
                const last = keyframes[keyframes.length - 1];
                if (Math.abs(time - last.time) < 0.01) {
                    return { x: last.x, y: last.y };
                }
            }

            return null;
        }

        // Draw the simulation
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!simulationData) {
                // Draw placeholder
                ctx.fillStyle = '#333';
                ctx.font = '14px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('Click "Run Simulation" to start', canvas.width / 2, canvas.height / 2);
                return;
            }

            const particles = simulationData.particles;
            let activeNo2 = 0;
            let activeN2o4 = 0;
            let collisionsSoFar = 0;

            // Count collisions that have occurred
            for (const collision of simulationData.collisions) {
                if (currentTime >= collision.time) {
                    collisionsSoFar++;
                }
            }

            // Draw collision flash effects
            for (const collision of simulationData.collisions) {
                const timeSinceCollision = currentTime - collision.time;
                if (timeSinceCollision >= 0 && timeSinceCollision < 0.4) {
                    const alpha = 1 - (timeSinceCollision / 0.4);
                    const radius = PARTICLE_RADIUS * 2 + timeSinceCollision * 50;
                    
                    ctx.beginPath();
                    ctx.arc(collision.x, collision.y, radius, 0, Math.PI * 2);
                    // Brighter yellow with higher opacity
                    ctx.fillStyle = `rgba(255, 255, 0, ${alpha * 0.75})`;
                    ctx.fill();
                }
            }

            // Draw particles
            for (const particle of particles) {
                const pos = getParticlePosition(particle, currentTime);
                if (!pos) continue;

                const isNo2 = particle.type === 'NO2';
                const image = isNo2 ? no2Image : n2o4Image;
                const width = isNo2 ? NO2_WIDTH : N2O4_WIDTH;
                const height = IMAGE_HEIGHT;

                // Count active particles
                if (isNo2) activeNo2++;
                else activeN2o4++;

                // Only draw if images are loaded
                if (imagesLoaded < 2) {
                    // Fallback to colored circle while loading
                    const color = isNo2 ? NO2_COLOR : N2O4_COLOR;
                    const radius = isNo2 ? PARTICLE_RADIUS : PARTICLE_RADIUS * 1.3;
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                    continue;
                }

                // Get or initialize random starting rotation for this particle
                if (!particleRotations.has(particle.id)) {
                    particleRotations.set(particle.id, Math.random() * 2 * Math.PI);
                }
                const startRotation = particleRotations.get(particle.id);

                // Calculate rotation angle (slow continuous rotation + starting rotation)
                // Rotate 360 degrees every 3 seconds
                const rotationSpeed = 2 * Math.PI / 3; // radians per second
                const angle = startRotation + currentTime * rotationSpeed;

                // Draw rotated SVG with optional brightening effect
                ctx.save();
                ctx.translate(pos.x, pos.y);
                ctx.rotate(angle);
                
                // Check if we need brightening effect for N2O4
                let needsBrightening = false;
                let brightenAmount = 0;
                if (!isNo2) {
                    const timeSinceCreation = currentTime - particle.start_time;
                    if (timeSinceCreation >= 0 && timeSinceCreation < 0.3) {
                        needsBrightening = true;
                        const fadeProgress = 1 - (timeSinceCreation / 0.3);
                        brightenAmount = fadeProgress * 0.6; // 0 to 0.6 brightness boost
                    }
                }
                
                if (needsBrightening) {
                    // Draw to offscreen canvas to manipulate pixels
                    offscreenCanvas.width = width;
                    offscreenCanvas.height = height;
                    offscreenCtx.clearRect(0, 0, width, height);
                    
                    // Draw the SVG image
                    offscreenCtx.drawImage(image, 0, 0, width, height);
                    
                    // Get image data and brighten pixels
                    const imageData = offscreenCtx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    // Brighten by increasing RGB values (preserving alpha)
                    for (let i = 0; i < data.length; i += 4) {
                        // Only brighten non-transparent pixels
                        if (data[i + 3] > 0) {
                            // Increase RGB values proportionally
                            data[i] = Math.min(255, data[i] + brightenAmount * (255 - data[i]));     // R
                            data[i + 1] = Math.min(255, data[i + 1] + brightenAmount * (255 - data[i + 1])); // G
                            data[i + 2] = Math.min(255, data[i + 2] + brightenAmount * (255 - data[i + 2])); // B
                            // Alpha channel (data[i + 3]) stays the same
                        }
                    }
                    
                    // Put modified image data back
                    offscreenCtx.putImageData(imageData, 0, 0);
                    
                    // Draw the brightened result to main canvas
                    ctx.drawImage(offscreenCanvas, -width / 2, -height / 2);
                } else {
                    // Draw normally
                    ctx.drawImage(image, -width / 2, -height / 2, width, height);
                }
                
                ctx.restore();
            }

            // Update stats
            document.getElementById('activeNo2').textContent = activeNo2;
            document.getElementById('activeN2o4').textContent = activeN2o4;
            document.getElementById('collisionCount').textContent = collisionsSoFar;
        }

        // Convert seconds to 60fps notation (e.g., 1.5s -> "1:30")
        function toFrameTime(seconds) {
            if (seconds === null || seconds === undefined || isNaN(seconds)) return '—';
            const wholeSecs = Math.floor(seconds);
            const frames = Math.round((seconds % 1) * 60);
            return `${wholeSecs}:${frames.toString().padStart(2, '0')}`;
        }

        // Copy value to clipboard with visual feedback
        function copyCell(element) {
            const value = element.getAttribute('data-value') || element.textContent;
            navigator.clipboard.writeText(value).then(() => {
                element.classList.add('copied');
                setTimeout(() => element.classList.remove('copied'), 600);
            });
        }

        // Populate data tables
        function populateDataTables() {
            if (!simulationData) return;

            // Show data section
            document.getElementById('dataSection').classList.add('visible');

            // Populate collision table
            const collisionBody = document.getElementById('collisionTableBody');
            collisionBody.innerHTML = '';

            for (const collision of simulationData.collisions) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="copyable" onclick="copyCell(this)" data-value="${toFrameTime(collision.time)}">${toFrameTime(collision.time)}</td>
                    <td>(${collision.x.toFixed(1)}, ${collision.y.toFixed(1)})</td>
                    <td>
                        <span class="particle-badge no2">NO₂ #${collision.particle1_id}</span>
                        <span class="particle-badge no2">NO₂ #${collision.particle2_id}</span>
                    </td>
                    <td class="arrow">→</td>
                    <td>
                        <span class="particle-badge n2o4">N₂O₄ #${collision.result_particle_id}</span>
                    </td>
                `;
                collisionBody.appendChild(row);
            }

            // Populate particle trajectories
            const trajContainer = document.getElementById('particleTrajectories');
            trajContainer.innerHTML = '';

            // Sort particles: NO2 first, then N2O4
            const sortedParticles = [...simulationData.particles].sort((a, b) => {
                if (a.type !== b.type) return a.type === 'NO2' ? -1 : 1;
                return a.id - b.id;
            });

            for (const particle of sortedParticles) {
                const isNo2 = particle.type === 'NO2';
                const typeClass = isNo2 ? 'no2' : 'n2o4';
                const typeName = isNo2 ? 'NO₂' : 'N₂O₄';
                
                // Find if this particle is involved in a collision
                let collisionInfo = '';
                if (isNo2) {
                    const collision = simulationData.collisions.find(
                        c => c.particle1_id === particle.id || c.particle2_id === particle.id
                    );
                    if (collision) {
                        collisionInfo = `Collides at ${toFrameTime(collision.time)} → N₂O₄ #${collision.result_particle_id}`;
                    } else {
                        collisionInfo = 'No collision';
                    }
                } else {
                    const collision = simulationData.collisions.find(c => c.result_particle_id === particle.id);
                    if (collision) {
                        collisionInfo = `Created from NO₂ #${collision.particle1_id} + #${collision.particle2_id}`;
                    }
                }

                const group = document.createElement('div');
                group.className = 'particle-group';
                group.innerHTML = `
                    <div class="particle-header" onclick="toggleParticle(this)">
                        <div class="particle-info">
                            <span class="particle-id ${typeClass}">${typeName} #${particle.id}</span>
                            <span class="particle-meta">${particle.keyframes.length} keyframes • ${toFrameTime(particle.start_time)} - ${toFrameTime(particle.end_time)}</span>
                        </div>
                        <div class="particle-meta">${collisionInfo}</div>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="particle-keyframes">
                        <p class="time-format-note">Time format: seconds:frames (60fps). Click any cell to copy.</p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Time (s:f)</th>
                                    <th>X (px)</th>
                                    <th>Y (px)</th>
                                    <th>Duration (s:f)</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${particle.keyframes.map((kf, idx) => {
                                    const durationSec = idx < particle.keyframes.length - 1 
                                        ? particle.keyframes[idx + 1].time - kf.time
                                        : null;
                                    const durationStr = durationSec !== null ? toFrameTime(durationSec) : '—';
                                    const xVal = kf.x.toFixed(1);
                                    const yVal = kf.y.toFixed(1);
                                    
                                    // Check if this is a start, end, or wall bounce
                                    let note = '';
                                    let highlightClass = '';
                                    if (idx === 0) {
                                        note = isNo2 ? 'Start' : 'Created (collision)';
                                        highlightClass = 'keyframe-highlight';
                                    } else if (idx === particle.keyframes.length - 1) {
                                        if (isNo2 && particle.end_time < simulationData.params.animation_duration) {
                                            note = 'Destroyed (collision)';
                                            highlightClass = 'keyframe-highlight';
                                        } else {
                                            note = 'End';
                                        }
                                    } else {
                                        // Check if at wall
                                        const atLeftWall = kf.x <= 1;
                                        const atRightWall = kf.x >= simulationData.params.container_width - 1;
                                        const atTopWall = kf.y >= simulationData.params.container_height - 1;
                                        const atBottomWall = kf.y <= 1;
                                        if (atLeftWall || atRightWall || atTopWall || atBottomWall) {
                                            note = 'Wall bounce';
                                        }
                                    }
                                    
                                    return `
                                        <tr class="${highlightClass}">
                                            <td>${idx}</td>
                                            <td class="copyable" onclick="copyCell(this)" data-value="${toFrameTime(kf.time)}">${toFrameTime(kf.time)}</td>
                                            <td class="copyable" onclick="copyCell(this)" data-value="${xVal}">${xVal}</td>
                                            <td class="copyable" onclick="copyCell(this)" data-value="${yVal}">${yVal}</td>
                                            <td class="copyable" onclick="copyCell(this)" data-value="${durationStr}">${durationStr}</td>
                                            <td><span class="collision-note">${note}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                trajContainer.appendChild(group);
            }
        }

        // Toggle particle details
        function toggleParticle(header) {
            header.classList.toggle('expanded');
            const keyframes = header.nextElementSibling;
            keyframes.classList.toggle('expanded');
        }

        // Copy all data as CSV
        document.getElementById('copyAllBtn').addEventListener('click', () => {
            if (!simulationData) return;

            let csv = 'particle_id,particle_type,keyframe_idx,x,y,time_frames,duration_frames\n';
            
            for (const particle of simulationData.particles) {
                for (let i = 0; i < particle.keyframes.length; i++) {
                    const kf = particle.keyframes[i];
                    const durationSec = i < particle.keyframes.length - 1 
                        ? particle.keyframes[i + 1].time - kf.time
                        : 0;
                    csv += `${particle.id},${particle.type},${i},${kf.x.toFixed(1)},${kf.y.toFixed(1)},${toFrameTime(kf.time)},${toFrameTime(durationSec)}\n`;
                }
            }

            navigator.clipboard.writeText(csv).then(() => {
                const btn = document.getElementById('copyAllBtn');
                btn.textContent = '✓ Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy All Data as CSV';
                    btn.classList.remove('copied');
                }, 2000);
            });
        });

        // Initial setup
        updateDisplayValues();
        draw();
    </script>
</body>
</html>

